<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOG MODULAR by Mircha Emanuel D'Angelo</title>
    <meta name="description" content="A virtual Moog Modular Synthesizer with 3 VCOs, ladder filter, ADSR envelopes, LFOs and effects. Made with ‚ù§Ô∏è by Mircha Emanuel D'Angelo.">
    <meta name="author" content="Mircha Emanuel D'Angelo">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="MOOG MODULAR by Mircha Emanuel D'Angelo">
    <meta property="og:description" content="A virtual Moog Modular Synthesizer with 3 VCOs, ladder filter, ADSR envelopes, LFOs and effects. Made with ‚ù§Ô∏è by Mircha Emanuel D'Angelo.">
    <meta property="og:site_name" content="MOOG MODULAR">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MOOG MODULAR by Mircha Emanuel D'Angelo">
    <meta name="twitter:description" content="A virtual Moog Modular Synthesizer with 3 VCOs, ladder filter, ADSR envelopes, LFOs and effects. Made with ‚ù§Ô∏è by Mircha Emanuel D'Angelo.">

    <!-- Schema.org -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Moog Modular Synthesizer",
        "description": "A virtual Moog Modular Synthesizer with 3 VCOs, ladder filter, ADSR envelopes, LFOs and effects.",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Any",
        "author": {
            "@type": "Person",
            "name": "Mircha Emanuel D'Angelo",
            "url": "https://a80.it"
        },
        "creator": {
            "@type": "Person",
            "name": "Mircha Emanuel D'Angelo",
            "url": "https://a80.it"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #2d1810 0%, #4a2c1a 50%, #2d1810 100%);
            border-bottom: 4px solid #8b4513;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 0 0 10px #ff8c00, 0 0 20px #ff6600;
            letter-spacing: 8px;
            font-weight: bold;
        }

        .header p {
            color: #cd853f;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .synth-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .module {
            background: linear-gradient(180deg, #3d3d3d 0%, #2a2a2a 50%, #1f1f1f 100%);
            border: 3px solid #555;
            border-radius: 10px;
            padding: 15px;
            box-shadow:
                inset 0 2px 5px rgba(255,255,255,0.1),
                0 5px 15px rgba(0,0,0,0.5);
            position: relative;
        }

        .module::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            border-radius: 2px;
        }

        .module-title {
            text-align: center;
            color: #ffd700;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255,215,0,0.5);
        }

        .vco-module { min-width: 180px; }
        .mixer-module { min-width: 150px; }
        .filter-module { min-width: 200px; }
        .adsr-module { min-width: 220px; }
        .lfo-module { min-width: 180px; }
        .effects-module { min-width: 200px; }
        .master-module { min-width: 150px; }

        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 5px;
        }

        .knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a4a4a 0%, #2a2a2a 50%, #1a1a1a 100%);
            border: 3px solid #666;
            position: relative;
            cursor: pointer;
            box-shadow:
                0 4px 8px rgba(0,0,0,0.4),
                inset 0 -2px 5px rgba(0,0,0,0.3),
                inset 0 2px 5px rgba(255,255,255,0.1);
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #ffd700, #ff8c00);
            border-radius: 2px;
            box-shadow: 0 0 5px #ffd700;
        }

        .knob.small {
            width: 45px;
            height: 45px;
        }

        .knob.small::after {
            top: 6px;
            width: 3px;
            height: 15px;
        }

        .knob-label {
            color: #aaa;
            font-size: 0.7em;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .knob-value {
            color: #ffd700;
            font-size: 0.65em;
            margin-top: 2px;
        }

        .knob-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Wave selector buttons */
        .wave-selector {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
        }

        .wave-btn {
            width: 35px;
            height: 30px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .wave-btn:hover {
            border-color: #ffd700;
        }

        .wave-btn.active {
            background: #3d2a00;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        .wave-btn svg {
            width: 20px;
            height: 15px;
            stroke: #ffd700;
            fill: none;
            stroke-width: 2;
        }

        /* LED indicators */
        .led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #330000;
            border: 1px solid #555;
            margin: 5px auto;
            transition: all 0.1s;
        }

        .led.on {
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
        }

        .led.green.on {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
        }

        /* Patch points */
        .patch-section {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }

        .patch-point {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #333, #111);
            border: 2px solid #666;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .patch-point:hover {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .patch-point.connected {
            background: radial-gradient(circle at 30% 30%, #ffd700, #996600);
        }

        .patch-point-label {
            font-size: 0.5em;
            color: #888;
            text-align: center;
            margin-top: 2px;
        }

        /* Keyboard */
        .keyboard-container {
            background: linear-gradient(180deg, #2d1810 0%, #1a0f0a 100%);
            padding: 20px;
            border-top: 4px solid #8b4513;
            margin-top: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .keyboard {
            display: flex;
            position: relative;
            height: 140px;
            width: fit-content;
            margin: 0 auto;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .white-key {
            width: 28px;
            height: 120px;
            background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 85%, #ccc 100%);
            border: 1px solid #999;
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            position: relative;
            z-index: 1;
            transition: all 0.05s;
            box-shadow:
                inset 0 -5px 10px rgba(0,0,0,0.1),
                0 3px 5px rgba(0,0,0,0.3);
        }

        .white-key:hover {
            background: linear-gradient(180deg, #fff 0%, #f0f0f0 85%, #ddd 100%);
        }

        .white-key:active, .white-key.pressed {
            background: linear-gradient(180deg, #ddd 0%, #ccc 85%, #bbb 100%);
            height: 118px;
            margin-top: 2px;
        }

        .black-key {
            width: 18px;
            height: 75px;
            background: linear-gradient(180deg, #333 0%, #1a1a1a 90%, #000 100%);
            border-radius: 0 0 3px 3px;
            cursor: pointer;
            position: absolute;
            z-index: 2;
            top: 0;
            transition: all 0.05s;
            box-shadow:
                inset 0 -3px 5px rgba(255,255,255,0.1),
                0 3px 8px rgba(0,0,0,0.5);
        }

        .black-key:hover {
            background: linear-gradient(180deg, #444 0%, #2a2a2a 90%, #111 100%);
        }

        .black-key:active, .black-key.pressed {
            background: linear-gradient(180deg, #222 0%, #111 90%, #000 100%);
            height: 73px;
            margin-top: 2px;
        }

        .key-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55em;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }

        .black-key .key-label {
            color: #ffd700;
            bottom: 4px;
            font-size: 0.5em;
        }

        .octave-marker {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            color: #888;
            pointer-events: none;
        }

        /* Oscilloscope */
        .oscilloscope {
            background: #001100;
            border: 3px solid #444;
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
        }

        .oscilloscope canvas {
            background: #001a00;
            border-radius: 5px;
            display: block;
        }

        .scope-label {
            color: #00ff00;
            font-size: 0.7em;
            text-align: center;
            margin-top: 5px;
        }

        /* Preset buttons */
        .preset-section {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 15px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 10px 20px;
            background: linear-gradient(180deg, #4a3520 0%, #2d1810 100%);
            border: 2px solid #8b4513;
            border-radius: 5px;
            color: #ffd700;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: linear-gradient(180deg, #5a4530 0%, #3d2820 100%);
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
        }

        /* Demo section */
        .demo-section {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 10px 15px;
            flex-wrap: wrap;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-top: 1px solid #333;
        }

        .demo-label {
            color: #00ffff;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            text-shadow: 0 0 5px #00ffff;
        }

        .demo-btn {
            padding: 8px 16px;
            background: linear-gradient(180deg, #0a3030 0%, #051a1a 100%);
            border: 2px solid #00ffff;
            border-radius: 5px;
            color: #00ffff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            transition: all 0.2s;
            text-shadow: 0 0 5px #00ffff;
        }

        .demo-btn:hover {
            background: linear-gradient(180deg, #0f4040 0%, #0a2a2a 100%);
            box-shadow: 0 0 15px rgba(0,255,255,0.4);
        }

        .demo-btn.playing {
            background: linear-gradient(180deg, #00ffff 0%, #008888 100%);
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 20px rgba(0,255,255,0.6);
        }

        .demo-btn.stop-btn {
            border-color: #ff6666;
            color: #ff6666;
            text-shadow: 0 0 5px #ff6666;
        }

        .demo-btn.stop-btn:hover {
            background: linear-gradient(180deg, #400a0a 0%, #1a0505 100%);
            box-shadow: 0 0 15px rgba(255,102,102,0.4);
        }

        /* Recording button */
        .demo-btn.rec-btn {
            border-color: #ff4444;
            color: #ff4444;
            text-shadow: 0 0 5px #ff4444;
        }

        .demo-btn.rec-btn:hover {
            background: linear-gradient(180deg, #400a0a 0%, #1a0505 100%);
            box-shadow: 0 0 15px rgba(255,68,68,0.4);
        }

        .demo-btn.rec-btn.recording {
            background: linear-gradient(180deg, #ff4444 0%, #cc0000 100%);
            color: #fff;
            text-shadow: none;
            animation: pulse-rec 1s infinite;
        }

        @keyframes pulse-rec {
            0%, 100% { box-shadow: 0 0 10px rgba(255,68,68,0.6); }
            50% { box-shadow: 0 0 25px rgba(255,68,68,0.9); }
        }

        /* Preset manager section */
        .preset-manager {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            padding: 10px 15px;
            flex-wrap: wrap;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-bottom: 1px solid #333;
        }

        .preset-manager-label {
            color: #ff9900;
            font-size: 0.85em;
            text-shadow: 0 0 5px #ff9900;
        }

        .preset-select {
            background: #1a1a1a;
            color: #ff9900;
            border: 2px solid #ff9900;
            border-radius: 5px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            min-width: 150px;
            cursor: pointer;
        }

        .preset-select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255,153,0,0.4);
        }

        .preset-manager-btn {
            padding: 8px 14px;
            background: linear-gradient(180deg, #302010 0%, #1a0f05 100%);
            border: 2px solid #ff9900;
            border-radius: 5px;
            color: #ff9900;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            transition: all 0.2s;
            text-shadow: 0 0 5px #ff9900;
        }

        .preset-manager-btn:hover {
            background: linear-gradient(180deg, #403020 0%, #2a1f15 100%);
            box-shadow: 0 0 15px rgba(255,153,0,0.4);
        }

        .preset-manager-btn.delete-btn {
            border-color: #ff6666;
            color: #ff6666;
            text-shadow: 0 0 5px #ff6666;
        }

        .preset-manager-btn.delete-btn:hover {
            background: linear-gradient(180deg, #400a0a 0%, #1a0505 100%);
            box-shadow: 0 0 15px rgba(255,102,102,0.4);
        }

        /* Info panel */
        .info-panel {
            text-align: center;
            padding: 15px;
            color: #888;
            font-size: 0.8em;
        }

        .info-panel kbd {
            background: #333;
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid #555;
            color: #ffd700;
        }

        /* Patch cables canvas */
        #patch-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Glide control */
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
        }

        .vertical-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 8px;
            background: linear-gradient(90deg, #1a1a1a, #333);
            border-radius: 4px;
            outline: none;
            border: 1px solid #555;
        }

        .vertical-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 25px;
            background: linear-gradient(180deg, #666, #333);
            border: 2px solid #888;
            border-radius: 3px;
            cursor: pointer;
        }

        .slider-label {
            color: #aaa;
            font-size: 0.7em;
            margin-top: 5px;
        }

        /* Sequencer */
        .sequencer-module {
            min-width: 400px;
        }

        .sequencer-grid {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .seq-step {
            width: 40px;
            height: 50px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .seq-step.active {
            border-color: #ffd700;
            background: #2a2000;
        }

        .seq-step.current {
            box-shadow: 0 0 15px #ffd700;
        }

        .seq-step input {
            width: 30px;
            background: transparent;
            border: none;
            color: #ffd700;
            text-align: center;
            font-size: 0.8em;
        }

        .transport {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .transport-btn {
            width: 50px;
            height: 40px;
            background: linear-gradient(180deg, #333, #1a1a1a);
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .transport-btn:hover {
            border-color: #ffd700;
        }

        .transport-btn.playing {
            background: linear-gradient(180deg, #003300, #001a00);
            border-color: #00ff00;
        }

        .transport-btn svg {
            width: 20px;
            height: 20px;
            fill: #ffd700;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MOOG MODULAR</h1>
        <p>by Mircha Emanuel D'Angelo - Use keyboard A-L or click the keys</p>
    </div>

    <canvas id="patch-canvas"></canvas>

    <div class="preset-manager">
        <span class="preset-manager-label">MY PRESETS:</span>
        <select class="preset-select" id="user-presets">
            <option value="">-- Select --</option>
        </select>
        <button class="preset-manager-btn" id="load-preset-btn">LOAD</button>
        <button class="preset-manager-btn" id="save-preset-btn">üíæ SAVE</button>
        <button class="preset-manager-btn delete-btn" id="delete-preset-btn">üóëÔ∏è DEL</button>
    </div>

    <div class="preset-section">
        <button class="preset-btn" onclick="loadPreset('init')">INIT</button>
        <button class="preset-btn" onclick="loadPreset('bass')">BASS</button>
        <button class="preset-btn" onclick="loadPreset('lead')">LEAD</button>
        <button class="preset-btn" onclick="loadPreset('pad')">PAD</button>
        <button class="preset-btn" onclick="loadPreset('brass')">BRASS</button>
        <button class="preset-btn" onclick="loadPreset('strings')">STRINGS</button>
        <button class="preset-btn" onclick="loadPreset('weird')">WEIRD</button>
    </div>

    <div class="demo-section">
        <span class="demo-label">DEMO:</span>
        <button class="demo-btn" data-demo="chase">CHASE</button>
        <button class="demo-btn" data-demo="space">SPACE</button>
        <button class="demo-btn" data-demo="italo">ITALO</button>
        <button class="demo-btn" data-demo="blade">BLADE RUNNER</button>
        <button class="demo-btn" data-demo="axelf">AXEL F</button>
        <button class="demo-btn" data-demo="bluemonday">BLUE MONDAY</button>
        <button class="demo-btn" data-demo="popcorn">POPCORN</button>
        <button class="demo-btn" data-demo="stranger">STRANGER</button>
        <button class="demo-btn" data-demo="toto">AFRICA</button>
        <button class="demo-btn" data-demo="sweetdreams">SWEET DREAMS</button>
        <button class="demo-btn stop-btn" id="stop-demo">STOP</button>
        <span class="demo-label" style="margin-left: 20px;">REC:</span>
        <button class="demo-btn rec-btn" id="rec-btn">üî¥ REC</button>
    </div>

    <div class="synth-container">
        <!-- VCO 1 -->
        <div class="module vco-module">
            <div class="module-title">VCO 1</div>
            <div class="led green" id="vco1-led"></div>
            <div class="wave-selector">
                <button class="wave-btn active" data-vco="1" data-wave="sawtooth" title="Sawtooth">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 10,3 10,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="1" data-wave="square" title="Square">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 0,3 10,3 10,12 20,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="1" data-wave="triangle" title="Triangle">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 5,3 15,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="1" data-wave="sine" title="Sine">
                    <svg viewBox="0 0 20 15"><path d="M0,7.5 Q5,0 10,7.5 T20,7.5"/></svg>
                </button>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="vco1-octave" data-min="-2" data-max="2" data-value="0"></div>
                    <div class="knob-label">Octave</div>
                    <div class="knob-value" id="vco1-octave-val">0</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="vco1-detune" data-min="-100" data-max="100" data-value="0"></div>
                    <div class="knob-label">Detune</div>
                    <div class="knob-value" id="vco1-detune-val">0</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="vco1-pw" data-min="0" data-max="100" data-value="50"></div>
                    <div class="knob-label">PW</div>
                    <div class="knob-value" id="vco1-pw-val">50</div>
                </div>
            </div>
        </div>

        <!-- VCO 2 -->
        <div class="module vco-module">
            <div class="module-title">VCO 2</div>
            <div class="led green" id="vco2-led"></div>
            <div class="wave-selector">
                <button class="wave-btn active" data-vco="2" data-wave="sawtooth" title="Sawtooth">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 10,3 10,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="2" data-wave="square" title="Square">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 0,3 10,3 10,12 20,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="2" data-wave="triangle" title="Triangle">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 5,3 15,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="2" data-wave="sine" title="Sine">
                    <svg viewBox="0 0 20 15"><path d="M0,7.5 Q5,0 10,7.5 T20,7.5"/></svg>
                </button>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="vco2-octave" data-min="-2" data-max="2" data-value="0"></div>
                    <div class="knob-label">Octave</div>
                    <div class="knob-value" id="vco2-octave-val">0</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="vco2-detune" data-min="-100" data-max="100" data-value="5"></div>
                    <div class="knob-label">Detune</div>
                    <div class="knob-value" id="vco2-detune-val">5</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="vco2-pw" data-min="0" data-max="100" data-value="50"></div>
                    <div class="knob-label">PW</div>
                    <div class="knob-value" id="vco2-pw-val">50</div>
                </div>
            </div>
        </div>

        <!-- VCO 3 -->
        <div class="module vco-module">
            <div class="module-title">VCO 3</div>
            <div class="led green" id="vco3-led"></div>
            <div class="wave-selector">
                <button class="wave-btn" data-vco="3" data-wave="sawtooth" title="Sawtooth">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 10,3 10,12 20,3"/></svg>
                </button>
                <button class="wave-btn active" data-vco="3" data-wave="square" title="Square">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 0,3 10,3 10,12 20,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="3" data-wave="triangle" title="Triangle">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 5,3 15,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-vco="3" data-wave="sine" title="Sine">
                    <svg viewBox="0 0 20 15"><path d="M0,7.5 Q5,0 10,7.5 T20,7.5"/></svg>
                </button>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="vco3-octave" data-min="-2" data-max="2" data-value="-1"></div>
                    <div class="knob-label">Octave</div>
                    <div class="knob-value" id="vco3-octave-val">-1</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="vco3-detune" data-min="-100" data-max="100" data-value="0"></div>
                    <div class="knob-label">Detune</div>
                    <div class="knob-value" id="vco3-detune-val">0</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="vco3-pw" data-min="0" data-max="100" data-value="50"></div>
                    <div class="knob-label">PW</div>
                    <div class="knob-value" id="vco3-pw-val">50</div>
                </div>
            </div>
        </div>

        <!-- Mixer -->
        <div class="module mixer-module">
            <div class="module-title">MIXER</div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="mix1" data-min="0" data-max="100" data-value="80"></div>
                    <div class="knob-label">VCO1</div>
                    <div class="knob-value" id="mix1-val">80</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="mix2" data-min="0" data-max="100" data-value="60"></div>
                    <div class="knob-label">VCO2</div>
                    <div class="knob-value" id="mix2-val">60</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="mix3" data-min="0" data-max="100" data-value="40"></div>
                    <div class="knob-label">VCO3</div>
                    <div class="knob-value" id="mix3-val">40</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="noise" data-min="0" data-max="100" data-value="0"></div>
                    <div class="knob-label">Noise</div>
                    <div class="knob-value" id="noise-val">0</div>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="module filter-module">
            <div class="module-title">LADDER FILTER</div>
            <div class="led" id="filter-led"></div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="cutoff" data-min="20" data-max="20000" data-value="2000" data-log="true"></div>
                    <div class="knob-label">Cutoff</div>
                    <div class="knob-value" id="cutoff-val">2000 Hz</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="resonance" data-min="0" data-max="100" data-value="30"></div>
                    <div class="knob-label">Resonance</div>
                    <div class="knob-value" id="resonance-val">30</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="filter-env" data-min="0" data-max="100" data-value="50"></div>
                    <div class="knob-label">Env Amt</div>
                    <div class="knob-value" id="filter-env-val">50</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="filter-kbd" data-min="0" data-max="100" data-value="50"></div>
                    <div class="knob-label">Kbd Track</div>
                    <div class="knob-value" id="filter-kbd-val">50</div>
                </div>
            </div>
        </div>

        <!-- Filter ADSR -->
        <div class="module adsr-module">
            <div class="module-title">FILTER ENVELOPE</div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="f-attack" data-min="0" data-max="5000" data-value="10"></div>
                    <div class="knob-label">A</div>
                    <div class="knob-value" id="f-attack-val">10ms</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="f-decay" data-min="0" data-max="5000" data-value="300"></div>
                    <div class="knob-label">D</div>
                    <div class="knob-value" id="f-decay-val">300ms</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="f-sustain" data-min="0" data-max="100" data-value="30"></div>
                    <div class="knob-label">S</div>
                    <div class="knob-value" id="f-sustain-val">30%</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="f-release" data-min="0" data-max="10000" data-value="500"></div>
                    <div class="knob-label">R</div>
                    <div class="knob-value" id="f-release-val">500ms</div>
                </div>
            </div>
            <canvas id="filter-env-display" width="200" height="60" style="display:block;margin:10px auto;background:#111;border-radius:5px;"></canvas>
        </div>

        <!-- Amp ADSR -->
        <div class="module adsr-module">
            <div class="module-title">AMP ENVELOPE</div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob small" data-param="a-attack" data-min="0" data-max="5000" data-value="10"></div>
                    <div class="knob-label">A</div>
                    <div class="knob-value" id="a-attack-val">10ms</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="a-decay" data-min="0" data-max="5000" data-value="200"></div>
                    <div class="knob-label">D</div>
                    <div class="knob-value" id="a-decay-val">200ms</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="a-sustain" data-min="0" data-max="100" data-value="70"></div>
                    <div class="knob-label">S</div>
                    <div class="knob-value" id="a-sustain-val">70%</div>
                </div>
                <div class="knob-container">
                    <div class="knob small" data-param="a-release" data-min="0" data-max="10000" data-value="300"></div>
                    <div class="knob-label">R</div>
                    <div class="knob-value" id="a-release-val">300ms</div>
                </div>
            </div>
            <canvas id="amp-env-display" width="200" height="60" style="display:block;margin:10px auto;background:#111;border-radius:5px;"></canvas>
        </div>

        <!-- LFO 1 -->
        <div class="module lfo-module">
            <div class="module-title">LFO 1</div>
            <div class="wave-selector">
                <button class="wave-btn" data-lfo="1" data-wave="sine" title="Sine">
                    <svg viewBox="0 0 20 15"><path d="M0,7.5 Q5,0 10,7.5 T20,7.5"/></svg>
                </button>
                <button class="wave-btn active" data-lfo="1" data-wave="triangle" title="Triangle">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 5,3 15,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-lfo="1" data-wave="square" title="Square">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 0,3 10,3 10,12 20,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-lfo="1" data-wave="sawtooth" title="Sawtooth">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 10,3 10,12 20,3"/></svg>
                </button>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="lfo1-rate" data-min="0.1" data-max="20" data-value="5"></div>
                    <div class="knob-label">Rate</div>
                    <div class="knob-value" id="lfo1-rate-val">5 Hz</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="lfo1-amount" data-min="0" data-max="100" data-value="0"></div>
                    <div class="knob-label">Amount</div>
                    <div class="knob-value" id="lfo1-amount-val">0</div>
                </div>
            </div>
            <div class="slider-container">
                <select id="lfo1-dest" style="background:#222;color:#ffd700;border:1px solid #555;padding:5px;border-radius:3px;">
                    <option value="pitch">Pitch</option>
                    <option value="filter">Filter</option>
                    <option value="amp">Amp</option>
                    <option value="pw">Pulse Width</option>
                </select>
                <div class="slider-label">Destination</div>
            </div>
        </div>

        <!-- LFO 2 -->
        <div class="module lfo-module">
            <div class="module-title">LFO 2</div>
            <div class="wave-selector">
                <button class="wave-btn active" data-lfo="2" data-wave="sine" title="Sine">
                    <svg viewBox="0 0 20 15"><path d="M0,7.5 Q5,0 10,7.5 T20,7.5"/></svg>
                </button>
                <button class="wave-btn" data-lfo="2" data-wave="triangle" title="Triangle">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 5,3 15,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-lfo="2" data-wave="square" title="Square">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 0,3 10,3 10,12 20,12 20,3"/></svg>
                </button>
                <button class="wave-btn" data-lfo="2" data-wave="sawtooth" title="Sawtooth">
                    <svg viewBox="0 0 20 15"><polyline points="0,12 10,3 10,12 20,3"/></svg>
                </button>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="lfo2-rate" data-min="0.1" data-max="20" data-value="1"></div>
                    <div class="knob-label">Rate</div>
                    <div class="knob-value" id="lfo2-rate-val">1 Hz</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="lfo2-amount" data-min="0" data-max="100" data-value="0"></div>
                    <div class="knob-label">Amount</div>
                    <div class="knob-value" id="lfo2-amount-val">0</div>
                </div>
            </div>
            <div class="slider-container">
                <select id="lfo2-dest" style="background:#222;color:#ffd700;border:1px solid #555;padding:5px;border-radius:3px;">
                    <option value="filter">Filter</option>
                    <option value="pitch">Pitch</option>
                    <option value="amp">Amp</option>
                    <option value="pw">Pulse Width</option>
                </select>
                <div class="slider-label">Destination</div>
            </div>
        </div>

        <!-- Effects -->
        <div class="module effects-module">
            <div class="module-title">EFFECTS</div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="delay-time" data-min="0" data-max="1000" data-value="300"></div>
                    <div class="knob-label">Delay</div>
                    <div class="knob-value" id="delay-time-val">300ms</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="delay-feedback" data-min="0" data-max="90" data-value="30"></div>
                    <div class="knob-label">Feedback</div>
                    <div class="knob-value" id="delay-feedback-val">30%</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="delay-mix" data-min="0" data-max="100" data-value="0"></div>
                    <div class="knob-label">Dly Mix</div>
                    <div class="knob-value" id="delay-mix-val">0%</div>
                </div>
                <div class="knob-container">
                    <div class="knob" data-param="reverb-mix" data-min="0" data-max="100" data-value="15"></div>
                    <div class="knob-label">Reverb</div>
                    <div class="knob-value" id="reverb-mix-val">15%</div>
                </div>
            </div>
        </div>

        <!-- Master -->
        <div class="module master-module">
            <div class="module-title">MASTER</div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="glide" data-min="0" data-max="500" data-value="0"></div>
                    <div class="knob-label">Glide</div>
                    <div class="knob-value" id="glide-val">0ms</div>
                </div>
            </div>
            <div class="knob-row">
                <div class="knob-container">
                    <div class="knob" data-param="master-vol" data-min="0" data-max="100" data-value="70"></div>
                    <div class="knob-label">Volume</div>
                    <div class="knob-value" id="master-vol-val">70</div>
                </div>
            </div>
            <div class="led green" id="master-led"></div>
        </div>

        <!-- Oscilloscope -->
        <div class="module oscilloscope">
            <div class="module-title">SCOPE</div>
            <canvas id="scope" width="250" height="120"></canvas>
            <div class="scope-label">WAVEFORM</div>
        </div>
    </div>

    <!-- Keyboard -->
    <div class="keyboard-container">
        <div class="keyboard" id="keyboard"></div>
    </div>

    <div class="info-panel">
        <p>Computer Keyboard: <kbd>A</kbd> <kbd>W</kbd> <kbd>S</kbd> <kbd>E</kbd> <kbd>D</kbd> <kbd>F</kbd> <kbd>T</kbd> <kbd>G</kbd> <kbd>Y</kbd> <kbd>H</kbd> <kbd>U</kbd> <kbd>J</kbd> <kbd>K</kbd> <kbd>O</kbd> <kbd>L</kbd></p>
        <p style="margin-top:10px;"><kbd>Z</kbd> / <kbd>X</kbd> Octave Down/Up | Drag knobs to adjust | Click presets to load sounds</p>
    </div>

    <script>
        // Audio Context
        let audioCtx = null;
        let masterGain = null;
        let analyser = null;
        let delayNode = null;
        let delayFeedback = null;
        let delayMix = null;
        let reverbNode = null;
        let reverbMix = null;
        let noiseNode = null;
        let noiseGain = null;

        // LFO nodes
        let lfo1Osc = null;
        let lfo1Gain = null;
        let lfo2Osc = null;
        let lfo2Gain = null;

        // Synth state
        const state = {
            vco1: { wave: 'sawtooth', octave: 0, detune: 0, pw: 50 },
            vco2: { wave: 'sawtooth', octave: 0, detune: 5, pw: 50 },
            vco3: { wave: 'square', octave: -1, detune: 0, pw: 50 },
            mixer: { vco1: 0.8, vco2: 0.6, vco3: 0.4, noise: 0 },
            filter: { cutoff: 2000, resonance: 30, envAmount: 50, kbdTrack: 50 },
            filterEnv: { attack: 10, decay: 300, sustain: 30, release: 500 },
            ampEnv: { attack: 10, decay: 200, sustain: 70, release: 300 },
            lfo1: { wave: 'triangle', rate: 5, amount: 0, dest: 'pitch' },
            lfo2: { wave: 'sine', rate: 1, amount: 0, dest: 'filter' },
            effects: { delayTime: 300, delayFeedback: 30, delayMix: 0, reverbMix: 15 },
            master: { volume: 0.7, glide: 0 },
            octaveShift: 0
        };

        // Active voices
        const voices = new Map();
        let lastFrequency = null;

        // Initialize audio
        function initAudio() {
            if (audioCtx) return;

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Master gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = state.master.volume;

            // Analyser for oscilloscope
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;

            // Delay effect
            delayNode = audioCtx.createDelay(2);
            delayNode.delayTime.value = state.effects.delayTime / 1000;

            delayFeedback = audioCtx.createGain();
            delayFeedback.gain.value = state.effects.delayFeedback / 100;

            delayMix = audioCtx.createGain();
            delayMix.gain.value = state.effects.delayMix / 100;

            const delayDry = audioCtx.createGain();
            delayDry.gain.value = 1;

            // Reverb (convolution)
            reverbNode = audioCtx.createConvolver();
            reverbMix = audioCtx.createGain();
            reverbMix.gain.value = state.effects.reverbMix / 100;

            const reverbDry = audioCtx.createGain();
            reverbDry.gain.value = 1;

            // Create impulse response for reverb
            createReverbImpulse();

            // Noise generator
            noiseNode = createNoiseGenerator();
            noiseGain = audioCtx.createGain();
            noiseGain.gain.value = 0;
            noiseNode.connect(noiseGain);

            // Routing
            masterGain.connect(delayDry);
            masterGain.connect(delayNode);
            delayNode.connect(delayFeedback);
            delayFeedback.connect(delayNode);
            delayNode.connect(delayMix);

            delayDry.connect(reverbDry);
            delayMix.connect(reverbDry);
            delayDry.connect(reverbNode);
            delayMix.connect(reverbNode);

            reverbNode.connect(reverbMix);
            reverbDry.connect(analyser);
            reverbMix.connect(analyser);

            analyser.connect(audioCtx.destination);

            // Create LFOs
            lfo1Osc = audioCtx.createOscillator();
            lfo1Osc.type = state.lfo1.wave;
            lfo1Osc.frequency.value = state.lfo1.rate;
            lfo1Gain = audioCtx.createGain();
            lfo1Gain.gain.value = state.lfo1.amount;
            lfo1Osc.connect(lfo1Gain);
            lfo1Osc.start();

            lfo2Osc = audioCtx.createOscillator();
            lfo2Osc.type = state.lfo2.wave;
            lfo2Osc.frequency.value = state.lfo2.rate;
            lfo2Gain = audioCtx.createGain();
            lfo2Gain.gain.value = state.lfo2.amount;
            lfo2Osc.connect(lfo2Gain);
            lfo2Osc.start();

            // Start oscilloscope
            drawOscilloscope();
        }

        // Create noise generator
        function createNoiseGenerator() {
            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            const whiteNoise = audioCtx.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            whiteNoise.start();

            return whiteNoise;
        }

        // Create reverb impulse response
        function createReverbImpulse() {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * 2;
            const impulse = audioCtx.createBuffer(2, length, sampleRate);

            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }

            reverbNode.buffer = impulse;
        }

        // Create a voice
        function createVoice(frequency, velocity = 1) {
            const voice = {
                oscs: [],
                gains: [],
                filter: null,
                vca: null,
                filterEnvTarget: null
            };

            // Create oscillators
            for (let i = 1; i <= 3; i++) {
                const vcoState = state[`vco${i}`];
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = vcoState.wave;
                const oscFreq = frequency * Math.pow(2, vcoState.octave) * Math.pow(2, vcoState.detune / 1200);

                if (state.master.glide > 0 && lastFrequency) {
                    osc.frequency.setValueAtTime(lastFrequency * Math.pow(2, vcoState.octave), audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(oscFreq, audioCtx.currentTime + state.master.glide / 1000);
                } else {
                    osc.frequency.value = oscFreq;
                }

                gain.gain.value = state.mixer[`vco${i}`] * 0.3;

                osc.connect(gain);
                voice.oscs.push(osc);
                voice.gains.push(gain);
            }

            // Filter with keyboard tracking
            voice.filter = audioCtx.createBiquadFilter();
            voice.filter.type = 'lowpass';

            const kbdTrackAmount = state.filter.kbdTrack / 100;
            const baseCutoff = state.filter.cutoff;
            const freqRatio = frequency / 261.63; // C4 reference
            const kbdCutoffMod = Math.pow(freqRatio, kbdTrackAmount);
            voice.filterEnvTarget = Math.min(baseCutoff * kbdCutoffMod, 20000);

            voice.filter.frequency.value = voice.filterEnvTarget;
            voice.filter.Q.value = state.filter.resonance / 5;

            // VCA
            voice.vca = audioCtx.createGain();
            voice.vca.gain.value = 0;

            // Connect oscillators to filter
            voice.gains.forEach(g => g.connect(voice.filter));

            // Connect noise
            noiseGain.connect(voice.filter);

            // Connect filter to VCA
            voice.filter.connect(voice.vca);
            voice.vca.connect(masterGain);

            // Apply envelopes
            const now = audioCtx.currentTime;

            // Filter envelope
            const filterEnvAmount = (state.filter.envAmount / 100) * voice.filterEnvTarget;
            const filterStart = Math.max(voice.filterEnvTarget - filterEnvAmount, 20);
            const filterPeak = Math.min(voice.filterEnvTarget + filterEnvAmount * 0.5, 20000);
            const filterSustain = filterStart + (filterPeak - filterStart) * (state.filterEnv.sustain / 100);

            voice.filter.frequency.setValueAtTime(filterStart, now);
            voice.filter.frequency.linearRampToValueAtTime(filterPeak, now + state.filterEnv.attack / 1000);
            voice.filter.frequency.linearRampToValueAtTime(filterSustain, now + (state.filterEnv.attack + state.filterEnv.decay) / 1000);

            // Amp envelope
            const peakVol = velocity;
            const sustainVol = peakVol * (state.ampEnv.sustain / 100);

            voice.vca.gain.setValueAtTime(0, now);
            voice.vca.gain.linearRampToValueAtTime(peakVol, now + state.ampEnv.attack / 1000);
            voice.vca.gain.linearRampToValueAtTime(sustainVol, now + (state.ampEnv.attack + state.ampEnv.decay) / 1000);

            // Start oscillators
            voice.oscs.forEach(osc => osc.start());

            // Connect LFOs to destinations
            voice.lfoConnections = [];

            // LFO 1 connections
            if (state.lfo1.amount > 0) {
                const lfo1Amount = state.lfo1.amount;
                if (state.lfo1.dest === 'pitch') {
                    // Modulate pitch (detune in cents)
                    voice.oscs.forEach(osc => {
                        const lfo1ToPitch = audioCtx.createGain();
                        lfo1ToPitch.gain.value = lfo1Amount * 2; // cents
                        lfo1Gain.connect(lfo1ToPitch);
                        lfo1ToPitch.connect(osc.detune);
                        voice.lfoConnections.push(lfo1ToPitch);
                    });
                } else if (state.lfo1.dest === 'filter') {
                    // Modulate filter cutoff
                    const lfo1ToFilter = audioCtx.createGain();
                    lfo1ToFilter.gain.value = lfo1Amount * 20; // Hz variation
                    lfo1Gain.connect(lfo1ToFilter);
                    lfo1ToFilter.connect(voice.filter.detune);
                    voice.lfoConnections.push(lfo1ToFilter);
                } else if (state.lfo1.dest === 'amp') {
                    // Modulate amplitude (tremolo)
                    const lfo1ToAmp = audioCtx.createGain();
                    lfo1ToAmp.gain.value = lfo1Amount / 200;
                    lfo1Gain.connect(lfo1ToAmp);
                    lfo1ToAmp.connect(voice.vca.gain);
                    voice.lfoConnections.push(lfo1ToAmp);
                }
            }

            // LFO 2 connections
            if (state.lfo2.amount > 0) {
                const lfo2Amount = state.lfo2.amount;
                if (state.lfo2.dest === 'pitch') {
                    voice.oscs.forEach(osc => {
                        const lfo2ToPitch = audioCtx.createGain();
                        lfo2ToPitch.gain.value = lfo2Amount * 2;
                        lfo2Gain.connect(lfo2ToPitch);
                        lfo2ToPitch.connect(osc.detune);
                        voice.lfoConnections.push(lfo2ToPitch);
                    });
                } else if (state.lfo2.dest === 'filter') {
                    const lfo2ToFilter = audioCtx.createGain();
                    lfo2ToFilter.gain.value = lfo2Amount * 20;
                    lfo2Gain.connect(lfo2ToFilter);
                    lfo2ToFilter.connect(voice.filter.detune);
                    voice.lfoConnections.push(lfo2ToFilter);
                } else if (state.lfo2.dest === 'amp') {
                    const lfo2ToAmp = audioCtx.createGain();
                    lfo2ToAmp.gain.value = lfo2Amount / 200;
                    lfo2Gain.connect(lfo2ToAmp);
                    lfo2ToAmp.connect(voice.vca.gain);
                    voice.lfoConnections.push(lfo2ToAmp);
                }
            }

            lastFrequency = frequency;
            return voice;
        }

        // Release a voice
        function releaseVoice(voice) {
            const now = audioCtx.currentTime;
            const releaseTime = state.ampEnv.release / 1000;
            const filterReleaseTime = state.filterEnv.release / 1000;

            voice.vca.gain.cancelScheduledValues(now);
            voice.vca.gain.setValueAtTime(voice.vca.gain.value, now);
            voice.vca.gain.linearRampToValueAtTime(0, now + releaseTime);

            voice.filter.frequency.cancelScheduledValues(now);
            voice.filter.frequency.setValueAtTime(voice.filter.frequency.value, now);
            voice.filter.frequency.linearRampToValueAtTime(20, now + filterReleaseTime);

            setTimeout(() => {
                voice.oscs.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
            }, Math.max(releaseTime, filterReleaseTime) * 1000 + 100);
        }

        // Note handling
        function noteOn(note, velocity = 1) {
            initAudio();

            if (voices.has(note)) return;

            const frequency = 440 * Math.pow(2, (note - 69) / 12);
            const voice = createVoice(frequency, velocity);
            voices.set(note, voice);

            // Update LEDs
            document.getElementById('vco1-led').classList.add('on');
            document.getElementById('vco2-led').classList.add('on');
            document.getElementById('vco3-led').classList.add('on');
            document.getElementById('master-led').classList.add('on');
        }

        function noteOff(note) {
            const voice = voices.get(note);
            if (voice) {
                releaseVoice(voice);
                voices.delete(note);
            }

            if (voices.size === 0) {
                document.getElementById('vco1-led').classList.remove('on');
                document.getElementById('vco2-led').classList.remove('on');
                document.getElementById('vco3-led').classList.remove('on');
                document.getElementById('master-led').classList.remove('on');
            }
        }

        // Oscilloscope
        function drawOscilloscope() {
            const canvas = document.getElementById('scope');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            function draw() {
                requestAnimationFrame(draw);

                if (!analyser) return;

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteTimeDomainData(dataArray);

                ctx.fillStyle = '#001a00';
                ctx.fillRect(0, 0, width, height);

                // Grid
                ctx.strokeStyle = '#003300';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, height * i / 4);
                    ctx.lineTo(width, height * i / 4);
                    ctx.stroke();
                }
                for (let i = 0; i <= 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(width * i / 4, 0);
                    ctx.lineTo(width * i / 4, height);
                    ctx.stroke();
                }

                // Waveform
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 5;
                ctx.beginPath();

                const sliceWidth = width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * height / 2;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            draw();
        }

        // Draw envelope display
        function drawEnvelope(canvasId, attack, decay, sustain, release) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, width, height);

            const totalTime = attack + decay + 500 + release;
            const aX = (attack / totalTime) * width;
            const dX = aX + (decay / totalTime) * width;
            const sX = dX + (500 / totalTime) * width;
            const rX = width;

            const sustainY = height - (sustain / 100) * (height - 10) - 5;

            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, height - 5);
            ctx.lineTo(aX, 5);
            ctx.lineTo(dX, sustainY);
            ctx.lineTo(sX, sustainY);
            ctx.lineTo(rX, height - 5);
            ctx.stroke();
        }

        // Create keyboard
        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');

            // Extended keyboard from C2 (MIDI 36) to C6 (MIDI 84)
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const blackNotes = [1, 3, 6, 8, 10]; // Indices of black keys in octave

            // Base keyboard mapping (relative offsets from base note)
            const keyOffsets = {
                'a': 0, 'w': 1, 's': 2, 'e': 3, 'd': 4, 'f': 5, 't': 6,
                'g': 7, 'y': 8, 'h': 9, 'u': 10, 'j': 11, 'k': 12, 'o': 13, 'l': 14
            };
            const baseNote = 60; // C4

            const whiteKeyWidth = 28;
            let whiteKeyIndex = 0;

            // Generate notes from C2 (36) to C6 (84)
            for (let midi = 36; midi <= 84; midi++) {
                const noteIndex = midi % 12;
                const octave = Math.floor(midi / 12) - 1;
                const noteName = noteNames[noteIndex];
                const isBlack = blackNotes.includes(noteIndex);

                const key = document.createElement('div');
                key.dataset.midi = midi;

                if (isBlack) {
                    key.className = 'black-key';
                    key.style.left = `${whiteKeyIndex * whiteKeyWidth - 9}px`;
                } else {
                    key.className = 'white-key';

                    // Add octave marker on C notes
                    if (noteName === 'C') {
                        const marker = document.createElement('span');
                        marker.className = 'octave-marker';
                        marker.textContent = `C${octave}`;
                        key.appendChild(marker);
                    }

                    whiteKeyIndex++;
                }

                // Mouse events
                key.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    noteOn(midi);
                    key.classList.add('pressed');
                });

                key.addEventListener('mouseup', () => {
                    noteOff(midi);
                    key.classList.remove('pressed');
                });

                key.addEventListener('mouseleave', () => {
                    noteOff(midi);
                    key.classList.remove('pressed');
                });

                keyboard.appendChild(key);
            }

            // Update keyboard labels based on octave shift
            function updateKeyboardLabels() {
                // Remove all existing key labels
                document.querySelectorAll('.key-label').forEach(label => {
                    if (!label.closest('.octave-marker')) {
                        label.remove();
                    }
                });

                // Add labels at current octave position
                const currentBase = baseNote + (state.octaveShift * 12);
                Object.entries(keyOffsets).forEach(([keyChar, offset]) => {
                    const midi = currentBase + offset;
                    const keyEl = document.querySelector(`[data-midi="${midi}"]`);
                    if (keyEl) {
                        const label = document.createElement('span');
                        label.className = 'key-label';
                        label.textContent = keyChar.toUpperCase();
                        keyEl.appendChild(label);
                    }
                });
            }

            // Initial label setup
            updateKeyboardLabels();

            // Calculate MIDI note from key press
            function getMidiFromKey(key) {
                if (keyOffsets[key] !== undefined) {
                    return baseNote + (state.octaveShift * 12) + keyOffsets[key];
                }
                return null;
            }

            document.addEventListener('keydown', (e) => {
                if (e.repeat) return;
                const key = e.key.toLowerCase();

                if (key === 'z') {
                    state.octaveShift = Math.max(state.octaveShift - 1, -2);
                    updateKeyboardLabels();
                    return;
                }
                if (key === 'x') {
                    state.octaveShift = Math.min(state.octaveShift + 1, 2);
                    updateKeyboardLabels();
                    return;
                }

                const midi = getMidiFromKey(key);
                if (midi !== null && midi >= 36 && midi <= 84) {
                    noteOn(midi);
                    const keyEl = document.querySelector(`[data-midi="${midi}"]`);
                    if (keyEl) keyEl.classList.add('pressed');
                }
            });

            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                const midi = getMidiFromKey(key);
                if (midi !== null && midi >= 36 && midi <= 84) {
                    noteOff(midi);
                    const keyEl = document.querySelector(`[data-midi="${midi}"]`);
                    if (keyEl) keyEl.classList.remove('pressed');
                }
            });
        }

        // Knob handling
        function initKnobs() {
            const knobs = document.querySelectorAll('.knob');

            knobs.forEach(knob => {
                const param = knob.dataset.param;
                const min = parseFloat(knob.dataset.min);
                const max = parseFloat(knob.dataset.max);
                let value = parseFloat(knob.dataset.value);
                const isLog = knob.dataset.log === 'true';

                updateKnobRotation(knob, value, min, max, isLog);
                updateKnobValue(param, value);

                let isDragging = false;
                let startY = 0;
                let startValue = 0;

                knob.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startY = e.clientY;
                    startValue = value;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const deltaY = startY - e.clientY;
                    const range = max - min;
                    const sensitivity = isLog ? 0.5 : 1;

                    if (isLog) {
                        const logMin = Math.log(min);
                        const logMax = Math.log(max);
                        const logStart = Math.log(startValue);
                        const logRange = logMax - logMin;
                        const newLogValue = logStart + (deltaY / 200) * logRange * sensitivity;
                        value = Math.exp(Math.max(logMin, Math.min(logMax, newLogValue)));
                    } else {
                        value = startValue + (deltaY / 200) * range * sensitivity;
                        value = Math.max(min, Math.min(max, value));
                    }

                    // Round for certain parameters
                    if (param.includes('octave')) {
                        value = Math.round(value);
                    }

                    knob.dataset.value = value;
                    updateKnobRotation(knob, value, min, max, isLog);
                    updateKnobValue(param, value);
                    applyParameter(param, value);
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            });
        }

        function updateKnobRotation(knob, value, min, max, isLog) {
            let normalizedValue;
            if (isLog) {
                normalizedValue = (Math.log(value) - Math.log(min)) / (Math.log(max) - Math.log(min));
            } else {
                normalizedValue = (value - min) / (max - min);
            }
            const rotation = -135 + normalizedValue * 270;
            knob.style.transform = `rotate(${rotation}deg)`;
        }

        function updateKnobValue(param, value) {
            const valEl = document.getElementById(`${param}-val`);
            if (!valEl) return;

            switch(param) {
                case 'cutoff':
                    valEl.textContent = value >= 1000 ? `${(value/1000).toFixed(1)}kHz` : `${Math.round(value)}Hz`;
                    break;
                case 'f-attack':
                case 'f-decay':
                case 'f-release':
                case 'a-attack':
                case 'a-decay':
                case 'a-release':
                case 'delay-time':
                case 'glide':
                    valEl.textContent = `${Math.round(value)}ms`;
                    break;
                case 'f-sustain':
                case 'a-sustain':
                case 'delay-feedback':
                case 'delay-mix':
                case 'reverb-mix':
                    valEl.textContent = `${Math.round(value)}%`;
                    break;
                case 'lfo1-rate':
                case 'lfo2-rate':
                    valEl.textContent = `${value.toFixed(1)} Hz`;
                    break;
                default:
                    valEl.textContent = Math.round(value);
            }
        }

        // Update all active voices in real-time
        function updateActiveVoices() {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;

            voices.forEach((voice, note) => {
                // Update oscillator frequencies and detune
                const baseFreq = 440 * Math.pow(2, (note - 69) / 12);

                for (let i = 0; i < 3; i++) {
                    const vcoState = state[`vco${i + 1}`];
                    const oscFreq = baseFreq * Math.pow(2, vcoState.octave) * Math.pow(2, vcoState.detune / 1200);
                    voice.oscs[i].frequency.setTargetAtTime(oscFreq, now, 0.01);
                    voice.gains[i].gain.setTargetAtTime(state.mixer[`vco${i + 1}`] * 0.3, now, 0.01);
                }

                // Update filter in real-time
                voice.filter.frequency.setTargetAtTime(state.filter.cutoff, now, 0.02);
                voice.filter.Q.setTargetAtTime(state.filter.resonance / 5, now, 0.02);
            });
        }

        // Update envelope sustain levels in real-time
        function updateActiveEnvelopes() {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;

            voices.forEach((voice) => {
                // Update amp envelope sustain level
                const ampSustain = state.ampEnv.sustain / 100;
                voice.vca.gain.cancelScheduledValues(now);
                voice.vca.gain.setTargetAtTime(ampSustain, now, 0.03);

                // Update filter envelope sustain level (matching createVoice calculation)
                const filterEnvAmount = (state.filter.envAmount / 100) * state.filter.cutoff;
                const filterStart = Math.max(state.filter.cutoff - filterEnvAmount, 20);
                const filterPeak = Math.min(state.filter.cutoff + filterEnvAmount * 0.5, 20000);
                const filterSustain = filterStart + (filterPeak - filterStart) * (state.filterEnv.sustain / 100);

                voice.filter.frequency.cancelScheduledValues(now);
                voice.filter.frequency.setTargetAtTime(Math.max(filterSustain, 20), now, 0.03);
            });
        }

        function applyParameter(param, value) {
            switch(param) {
                case 'vco1-octave':
                    state.vco1.octave = value;
                    updateActiveVoices();
                    break;
                case 'vco1-detune':
                    state.vco1.detune = value;
                    updateActiveVoices();
                    break;
                case 'vco1-pw': state.vco1.pw = value; break;
                case 'vco2-octave':
                    state.vco2.octave = value;
                    updateActiveVoices();
                    break;
                case 'vco2-detune':
                    state.vco2.detune = value;
                    updateActiveVoices();
                    break;
                case 'vco2-pw': state.vco2.pw = value; break;
                case 'vco3-octave':
                    state.vco3.octave = value;
                    updateActiveVoices();
                    break;
                case 'vco3-detune':
                    state.vco3.detune = value;
                    updateActiveVoices();
                    break;
                case 'vco3-pw': state.vco3.pw = value; break;
                case 'mix1':
                    state.mixer.vco1 = value / 100;
                    updateActiveVoices();
                    break;
                case 'mix2':
                    state.mixer.vco2 = value / 100;
                    updateActiveVoices();
                    break;
                case 'mix3':
                    state.mixer.vco3 = value / 100;
                    updateActiveVoices();
                    break;
                case 'noise':
                    state.mixer.noise = value / 100;
                    if (noiseGain) noiseGain.gain.value = value / 100 * 0.3;
                    break;
                case 'cutoff':
                    state.filter.cutoff = value;
                    updateActiveVoices();
                    break;
                case 'resonance':
                    state.filter.resonance = value;
                    updateActiveVoices();
                    break;
                case 'filter-env': state.filter.envAmount = value; break;
                case 'filter-kbd': state.filter.kbdTrack = value; break;
                case 'f-attack':
                    state.filterEnv.attack = value;
                    drawEnvelope('filter-env-display', state.filterEnv.attack, state.filterEnv.decay, state.filterEnv.sustain, state.filterEnv.release);
                    break;
                case 'f-decay':
                    state.filterEnv.decay = value;
                    drawEnvelope('filter-env-display', state.filterEnv.attack, state.filterEnv.decay, state.filterEnv.sustain, state.filterEnv.release);
                    updateActiveEnvelopes();
                    break;
                case 'f-sustain':
                    state.filterEnv.sustain = value;
                    drawEnvelope('filter-env-display', state.filterEnv.attack, state.filterEnv.decay, state.filterEnv.sustain, state.filterEnv.release);
                    updateActiveEnvelopes();
                    break;
                case 'f-release':
                    state.filterEnv.release = value;
                    drawEnvelope('filter-env-display', state.filterEnv.attack, state.filterEnv.decay, state.filterEnv.sustain, state.filterEnv.release);
                    break;
                case 'a-attack':
                    state.ampEnv.attack = value;
                    drawEnvelope('amp-env-display', state.ampEnv.attack, state.ampEnv.decay, state.ampEnv.sustain, state.ampEnv.release);
                    break;
                case 'a-decay':
                    state.ampEnv.decay = value;
                    drawEnvelope('amp-env-display', state.ampEnv.attack, state.ampEnv.decay, state.ampEnv.sustain, state.ampEnv.release);
                    updateActiveEnvelopes();
                    break;
                case 'a-sustain':
                    state.ampEnv.sustain = value;
                    drawEnvelope('amp-env-display', state.ampEnv.attack, state.ampEnv.decay, state.ampEnv.sustain, state.ampEnv.release);
                    updateActiveEnvelopes();
                    break;
                case 'a-release':
                    state.ampEnv.release = value;
                    drawEnvelope('amp-env-display', state.ampEnv.attack, state.ampEnv.decay, state.ampEnv.sustain, state.ampEnv.release);
                    break;
                case 'lfo1-rate':
                    state.lfo1.rate = value;
                    if (lfo1Osc) lfo1Osc.frequency.value = value;
                    break;
                case 'lfo1-amount':
                    state.lfo1.amount = value;
                    if (lfo1Gain) lfo1Gain.gain.value = value;
                    break;
                case 'lfo2-rate':
                    state.lfo2.rate = value;
                    if (lfo2Osc) lfo2Osc.frequency.value = value;
                    break;
                case 'lfo2-amount':
                    state.lfo2.amount = value;
                    if (lfo2Gain) lfo2Gain.gain.value = value;
                    break;
                case 'delay-time':
                    state.effects.delayTime = value;
                    if (delayNode) delayNode.delayTime.value = value / 1000;
                    break;
                case 'delay-feedback':
                    state.effects.delayFeedback = value;
                    if (delayFeedback) delayFeedback.gain.value = value / 100;
                    break;
                case 'delay-mix':
                    state.effects.delayMix = value;
                    if (delayMix) delayMix.gain.value = value / 100;
                    break;
                case 'reverb-mix':
                    state.effects.reverbMix = value;
                    if (reverbMix) reverbMix.gain.value = value / 100;
                    break;
                case 'glide': state.master.glide = value; break;
                case 'master-vol':
                    state.master.volume = value / 100;
                    if (masterGain) masterGain.gain.value = value / 100;
                    break;
            }
        }

        // Wave selector handling
        // Update waveforms on active voices in real-time
        function updateActiveWaveforms() {
            voices.forEach((voice) => {
                for (let i = 0; i < 3; i++) {
                    const vcoState = state[`vco${i + 1}`];
                    voice.oscs[i].type = vcoState.wave;
                }
            });
        }

        function initWaveSelectors() {
            // VCO wave selectors
            document.querySelectorAll('.wave-btn[data-vco]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const vco = btn.dataset.vco;
                    const wave = btn.dataset.wave;

                    document.querySelectorAll(`.wave-btn[data-vco="${vco}"]`).forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    state[`vco${vco}`].wave = wave;
                    updateActiveWaveforms();
                });
            });

            // LFO wave selectors
            document.querySelectorAll('.wave-btn[data-lfo]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const lfo = btn.dataset.lfo;
                    const wave = btn.dataset.wave;

                    document.querySelectorAll(`.wave-btn[data-lfo="${lfo}"]`).forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    state[`lfo${lfo}`].wave = wave;

                    // Update LFO oscillator waveform in real-time
                    if (lfo === '1' && lfo1Osc) lfo1Osc.type = wave;
                    if (lfo === '2' && lfo2Osc) lfo2Osc.type = wave;
                });
            });

            // LFO destination selectors
            document.getElementById('lfo1-dest').addEventListener('change', (e) => {
                state.lfo1.dest = e.target.value;
            });

            document.getElementById('lfo2-dest').addEventListener('change', (e) => {
                state.lfo2.dest = e.target.value;
            });
        }

        // Presets
        const presets = {
            init: {
                vco1: { wave: 'sawtooth', octave: 0, detune: 0 },
                vco2: { wave: 'sawtooth', octave: 0, detune: 5 },
                vco3: { wave: 'square', octave: -1, detune: 0 },
                mixer: { vco1: 80, vco2: 60, vco3: 40, noise: 0 },
                filter: { cutoff: 2000, resonance: 30, envAmount: 50, kbdTrack: 50 },
                filterEnv: { attack: 10, decay: 300, sustain: 30, release: 500 },
                ampEnv: { attack: 10, decay: 200, sustain: 70, release: 300 },
                effects: { delayTime: 300, delayFeedback: 30, delayMix: 0, reverbMix: 15 },
                glide: 0
            },
            bass: {
                vco1: { wave: 'sawtooth', octave: -1, detune: 0 },
                vco2: { wave: 'square', octave: -1, detune: 7 },
                vco3: { wave: 'sine', octave: -2, detune: 0 },
                mixer: { vco1: 100, vco2: 70, vco3: 60, noise: 0 },
                filter: { cutoff: 400, resonance: 40, envAmount: 70, kbdTrack: 30 },
                filterEnv: { attack: 5, decay: 200, sustain: 20, release: 200 },
                ampEnv: { attack: 5, decay: 100, sustain: 80, release: 150 },
                effects: { delayTime: 300, delayFeedback: 20, delayMix: 0, reverbMix: 5 },
                glide: 50
            },
            lead: {
                vco1: { wave: 'sawtooth', octave: 0, detune: 0 },
                vco2: { wave: 'sawtooth', octave: 0, detune: 10 },
                vco3: { wave: 'square', octave: 1, detune: 0 },
                mixer: { vco1: 100, vco2: 80, vco3: 30, noise: 0 },
                filter: { cutoff: 3000, resonance: 50, envAmount: 60, kbdTrack: 70 },
                filterEnv: { attack: 10, decay: 400, sustain: 40, release: 400 },
                ampEnv: { attack: 10, decay: 200, sustain: 80, release: 300 },
                effects: { delayTime: 350, delayFeedback: 40, delayMix: 25, reverbMix: 20 },
                glide: 30
            },
            pad: {
                vco1: { wave: 'sawtooth', octave: 0, detune: -5 },
                vco2: { wave: 'sawtooth', octave: 0, detune: 5 },
                vco3: { wave: 'triangle', octave: -1, detune: 0 },
                mixer: { vco1: 70, vco2: 70, vco3: 50, noise: 5 },
                filter: { cutoff: 1500, resonance: 20, envAmount: 30, kbdTrack: 40 },
                filterEnv: { attack: 500, decay: 1000, sustain: 60, release: 2000 },
                ampEnv: { attack: 800, decay: 500, sustain: 70, release: 1500 },
                effects: { delayTime: 400, delayFeedback: 50, delayMix: 30, reverbMix: 50 },
                glide: 100
            },
            brass: {
                vco1: { wave: 'sawtooth', octave: 0, detune: 0 },
                vco2: { wave: 'sawtooth', octave: 0, detune: 3 },
                vco3: { wave: 'square', octave: 0, detune: -3 },
                mixer: { vco1: 80, vco2: 80, vco3: 60, noise: 0 },
                filter: { cutoff: 800, resonance: 30, envAmount: 80, kbdTrack: 60 },
                filterEnv: { attack: 50, decay: 300, sustain: 50, release: 300 },
                ampEnv: { attack: 30, decay: 100, sustain: 85, release: 200 },
                effects: { delayTime: 300, delayFeedback: 20, delayMix: 10, reverbMix: 25 },
                glide: 0
            },
            strings: {
                vco1: { wave: 'sawtooth', octave: 0, detune: -8 },
                vco2: { wave: 'sawtooth', octave: 0, detune: 8 },
                vco3: { wave: 'sawtooth', octave: -1, detune: 0 },
                mixer: { vco1: 60, vco2: 60, vco3: 40, noise: 3 },
                filter: { cutoff: 2500, resonance: 15, envAmount: 20, kbdTrack: 50 },
                filterEnv: { attack: 300, decay: 500, sustain: 70, release: 1000 },
                ampEnv: { attack: 400, decay: 300, sustain: 75, release: 800 },
                effects: { delayTime: 300, delayFeedback: 30, delayMix: 15, reverbMix: 40 },
                glide: 50
            },
            weird: {
                vco1: { wave: 'square', octave: 0, detune: -50 },
                vco2: { wave: 'sawtooth', octave: 1, detune: 50 },
                vco3: { wave: 'triangle', octave: -2, detune: 25 },
                mixer: { vco1: 80, vco2: 60, vco3: 100, noise: 20 },
                filter: { cutoff: 5000, resonance: 80, envAmount: 90, kbdTrack: 100 },
                filterEnv: { attack: 100, decay: 800, sustain: 10, release: 2000 },
                ampEnv: { attack: 50, decay: 400, sustain: 50, release: 1000 },
                effects: { delayTime: 666, delayFeedback: 70, delayMix: 50, reverbMix: 60 },
                glide: 200
            }
        };

        function loadPreset(name) {
            const preset = presets[name];
            if (!preset) return;

            // Update knobs
            function setKnob(param, value) {
                const knob = document.querySelector(`[data-param="${param}"]`);
                if (knob) {
                    knob.dataset.value = value;
                    const min = parseFloat(knob.dataset.min);
                    const max = parseFloat(knob.dataset.max);
                    const isLog = knob.dataset.log === 'true';
                    updateKnobRotation(knob, value, min, max, isLog);
                    updateKnobValue(param, value);
                    applyParameter(param, value);
                }
            }

            // VCOs
            for (let i = 1; i <= 3; i++) {
                const vco = preset[`vco${i}`];
                setKnob(`vco${i}-octave`, vco.octave);
                setKnob(`vco${i}-detune`, vco.detune);

                // Set wave
                document.querySelectorAll(`.wave-btn[data-vco="${i}"]`).forEach(b => {
                    b.classList.toggle('active', b.dataset.wave === vco.wave);
                });
                state[`vco${i}`].wave = vco.wave;
            }

            // Mixer
            setKnob('mix1', preset.mixer.vco1);
            setKnob('mix2', preset.mixer.vco2);
            setKnob('mix3', preset.mixer.vco3);
            setKnob('noise', preset.mixer.noise);

            // Filter
            setKnob('cutoff', preset.filter.cutoff);
            setKnob('resonance', preset.filter.resonance);
            setKnob('filter-env', preset.filter.envAmount);
            setKnob('filter-kbd', preset.filter.kbdTrack);

            // Envelopes
            setKnob('f-attack', preset.filterEnv.attack);
            setKnob('f-decay', preset.filterEnv.decay);
            setKnob('f-sustain', preset.filterEnv.sustain);
            setKnob('f-release', preset.filterEnv.release);

            setKnob('a-attack', preset.ampEnv.attack);
            setKnob('a-decay', preset.ampEnv.decay);
            setKnob('a-sustain', preset.ampEnv.sustain);
            setKnob('a-release', preset.ampEnv.release);

            // Effects
            setKnob('delay-time', preset.effects.delayTime);
            setKnob('delay-feedback', preset.effects.delayFeedback);
            setKnob('delay-mix', preset.effects.delayMix);
            setKnob('reverb-mix', preset.effects.reverbMix);

            // Glide
            setKnob('glide', preset.glide);
        }

        // Demo Sequencer
        let demoInterval = null;
        let demoTimeouts = [];
        let currentDemo = null;

        const demos = {
            chase: {
                preset: 'lead',
                bpm: 130,
                loop: true,
                pattern: [
                    // E minor arpeggio - classic Chase style
                    { note: 64, time: 0, duration: 100 },      // E4
                    { note: 67, time: 115, duration: 100 },    // G4
                    { note: 71, time: 230, duration: 100 },    // B4
                    { note: 76, time: 345, duration: 100 },    // E5
                    { note: 71, time: 460, duration: 100 },    // B4
                    { note: 67, time: 575, duration: 100 },    // G4
                    { note: 64, time: 690, duration: 100 },    // E4
                    { note: 67, time: 805, duration: 100 },    // G4
                    { note: 71, time: 920, duration: 100 },    // B4
                    { note: 76, time: 1035, duration: 100 },   // E5
                    { note: 71, time: 1150, duration: 100 },   // B4
                    { note: 67, time: 1265, duration: 100 },   // G4
                    { note: 64, time: 1380, duration: 100 },   // E4
                    { note: 67, time: 1495, duration: 100 },   // G4
                    { note: 71, time: 1610, duration: 100 },   // B4
                    { note: 76, time: 1725, duration: 100 },   // E5
                ],
                loopLength: 1840
            },
            space: {
                preset: 'pad',
                bpm: 70,
                loop: true,
                pattern: [
                    // Dm chord
                    { note: 62, time: 0, duration: 2500 },     // D4
                    { note: 65, time: 50, duration: 2450 },    // F4
                    { note: 69, time: 100, duration: 2400 },   // A4
                    // Am chord
                    { note: 57, time: 3000, duration: 2500 },  // A3
                    { note: 60, time: 3050, duration: 2450 },  // C4
                    { note: 64, time: 3100, duration: 2400 },  // E4
                    // C chord
                    { note: 60, time: 6000, duration: 2500 },  // C4
                    { note: 64, time: 6050, duration: 2450 },  // E4
                    { note: 67, time: 6100, duration: 2400 },  // G4
                    // G chord
                    { note: 55, time: 9000, duration: 2500 },  // G3
                    { note: 59, time: 9050, duration: 2450 },  // B3
                    { note: 62, time: 9100, duration: 2400 },  // D4
                ],
                loopLength: 12000
            },
            italo: {
                preset: 'bass',
                bpm: 120,
                loop: true,
                pattern: [
                    // Bass octave pulse in E
                    { note: 40, time: 0, duration: 150 },      // E2
                    { note: 52, time: 250, duration: 150 },    // E3
                    { note: 40, time: 500, duration: 150 },    // E2
                    { note: 52, time: 750, duration: 150 },    // E3
                    { note: 40, time: 1000, duration: 150 },   // E2
                    { note: 52, time: 1250, duration: 150 },   // E3
                    { note: 40, time: 1500, duration: 150 },   // E2
                    { note: 52, time: 1750, duration: 150 },   // E3
                    // Melodic sequence
                    { note: 64, time: 2000, duration: 200 },   // E4
                    { note: 67, time: 2250, duration: 200 },   // G4
                    { note: 69, time: 2500, duration: 200 },   // A4
                    { note: 71, time: 2750, duration: 200 },   // B4
                    { note: 69, time: 3000, duration: 200 },   // A4
                    { note: 67, time: 3250, duration: 200 },   // G4
                    { note: 64, time: 3500, duration: 200 },   // E4
                    { note: 62, time: 3750, duration: 200 },   // D4
                ],
                loopLength: 4000
            },
            blade: {
                preset: 'strings',
                bpm: 60,
                loop: true,
                pattern: [
                    // Cm7 chord
                    { note: 48, time: 0, duration: 3800 },     // C3
                    { note: 55, time: 100, duration: 3700 },   // G3
                    { note: 58, time: 200, duration: 3600 },   // Bb3
                    { note: 63, time: 300, duration: 3500 },   // Eb4
                    // Fm7 chord
                    { note: 53, time: 4000, duration: 3800 },  // F3
                    { note: 60, time: 4100, duration: 3700 },  // C4
                    { note: 63, time: 4200, duration: 3600 },  // Eb4
                    { note: 68, time: 4300, duration: 3500 },  // Ab4
                    // Abmaj7 chord
                    { note: 56, time: 8000, duration: 3800 },  // Ab3
                    { note: 60, time: 8100, duration: 3700 },  // C4
                    { note: 63, time: 8200, duration: 3600 },  // Eb4
                    { note: 67, time: 8300, duration: 3500 },  // G4
                    // Gm chord
                    { note: 55, time: 12000, duration: 3800 }, // G3
                    { note: 58, time: 12100, duration: 3700 }, // Bb3
                    { note: 62, time: 12200, duration: 3600 }, // D4
                    { note: 67, time: 12300, duration: 3500 }, // G4
                ],
                loopLength: 16000
            },
            axelf: {
                preset: 'lead',
                bpm: 120,
                loop: true,
                pattern: [
                    // Axel F theme - Beverly Hills Cop
                    { note: 65, time: 0, duration: 150 },      // F4
                    { note: 68, time: 200, duration: 150 },    // Ab4
                    { note: 65, time: 400, duration: 100 },    // F4
                    { note: 65, time: 550, duration: 100 },    // F4
                    { note: 70, time: 700, duration: 150 },    // Bb4
                    { note: 65, time: 900, duration: 150 },    // F4
                    { note: 63, time: 1100, duration: 150 },   // Eb4
                    { note: 65, time: 1300, duration: 150 },   // F4
                    { note: 72, time: 1500, duration: 150 },   // C5
                    { note: 65, time: 1700, duration: 100 },   // F4
                    { note: 65, time: 1850, duration: 100 },   // F4
                    { note: 73, time: 2000, duration: 150 },   // Db5
                    { note: 72, time: 2200, duration: 150 },   // C5
                    { note: 68, time: 2400, duration: 150 },   // Ab4
                    { note: 65, time: 2600, duration: 150 },   // F4
                    { note: 72, time: 2800, duration: 150 },   // C5
                    { note: 77, time: 3000, duration: 150 },   // F5
                    { note: 65, time: 3200, duration: 100 },   // F4
                    { note: 63, time: 3350, duration: 100 },   // Eb4
                    { note: 63, time: 3500, duration: 100 },   // Eb4
                    { note: 60, time: 3650, duration: 150 },   // C4
                    { note: 67, time: 3850, duration: 250 },   // G4
                ],
                loopLength: 4200
            },
            bluemonday: {
                preset: 'bass',
                bpm: 130,
                loop: true,
                pattern: [
                    // Blue Monday - New Order bass line
                    { note: 41, time: 0, duration: 100 },      // F2
                    { note: 41, time: 230, duration: 100 },    // F2
                    { note: 41, time: 460, duration: 100 },    // F2
                    { note: 48, time: 690, duration: 100 },    // C3
                    { note: 46, time: 920, duration: 100 },    // Bb2
                    { note: 41, time: 1150, duration: 100 },   // F2
                    { note: 41, time: 1380, duration: 100 },   // F2
                    { note: 41, time: 1610, duration: 100 },   // F2
                    { note: 41, time: 1840, duration: 100 },   // F2
                    { note: 41, time: 2070, duration: 100 },   // F2
                    { note: 48, time: 2300, duration: 100 },   // C3
                    { note: 46, time: 2530, duration: 100 },   // Bb2
                    { note: 43, time: 2760, duration: 100 },   // G2
                    { note: 41, time: 2990, duration: 100 },   // F2
                    { note: 43, time: 3220, duration: 100 },   // G2
                    { note: 44, time: 3450, duration: 100 },   // Ab2
                ],
                loopLength: 3680
            },
            popcorn: {
                preset: 'lead',
                bpm: 140,
                loop: true,
                pattern: [
                    // Popcorn - Hot Butter
                    { note: 76, time: 0, duration: 80 },       // E5
                    { note: 74, time: 107, duration: 80 },     // D5
                    { note: 76, time: 214, duration: 80 },     // E5
                    { note: 71, time: 321, duration: 80 },     // B4
                    { note: 67, time: 428, duration: 80 },     // G4
                    { note: 71, time: 535, duration: 80 },     // B4
                    { note: 64, time: 642, duration: 80 },     // E4
                    // Second phrase
                    { note: 76, time: 857, duration: 80 },     // E5
                    { note: 74, time: 964, duration: 80 },     // D5
                    { note: 76, time: 1071, duration: 80 },    // E5
                    { note: 71, time: 1178, duration: 80 },    // B4
                    { note: 67, time: 1285, duration: 80 },    // G4
                    { note: 71, time: 1392, duration: 80 },    // B4
                    { note: 64, time: 1499, duration: 80 },    // E4
                    // Third phrase - variation
                    { note: 76, time: 1714, duration: 80 },    // E5
                    { note: 78, time: 1821, duration: 80 },    // F#5
                    { note: 76, time: 1928, duration: 80 },    // E5
                    { note: 78, time: 2035, duration: 80 },    // F#5
                    { note: 74, time: 2142, duration: 80 },    // D5
                    { note: 76, time: 2249, duration: 80 },    // E5
                    { note: 74, time: 2356, duration: 80 },    // D5
                    { note: 76, time: 2463, duration: 80 },    // E5
                    { note: 71, time: 2570, duration: 80 },    // B4
                ],
                loopLength: 2784
            },
            stranger: {
                preset: 'pad',
                bpm: 80,
                loop: true,
                pattern: [
                    // Stranger Things style - dark synth arpeggio
                    { note: 48, time: 0, duration: 200 },      // C3
                    { note: 55, time: 375, duration: 200 },    // G3
                    { note: 60, time: 750, duration: 200 },    // C4
                    { note: 63, time: 1125, duration: 200 },   // Eb4
                    { note: 60, time: 1500, duration: 200 },   // C4
                    { note: 55, time: 1875, duration: 200 },   // G3
                    { note: 48, time: 2250, duration: 200 },   // C3
                    { note: 55, time: 2625, duration: 200 },   // G3
                    // Second part - Am
                    { note: 45, time: 3000, duration: 200 },   // A2
                    { note: 52, time: 3375, duration: 200 },   // E3
                    { note: 57, time: 3750, duration: 200 },   // A3
                    { note: 60, time: 4125, duration: 200 },   // C4
                    { note: 57, time: 4500, duration: 200 },   // A3
                    { note: 52, time: 4875, duration: 200 },   // E3
                    { note: 45, time: 5250, duration: 200 },   // A2
                    { note: 52, time: 5625, duration: 200 },   // E3
                ],
                loopLength: 6000
            },
            toto: {
                preset: 'brass',
                bpm: 116,
                loop: true,
                pattern: [
                    // Africa - Toto style synth brass
                    { note: 69, time: 0, duration: 300 },      // A4
                    { note: 67, time: 350, duration: 150 },    // G4
                    { note: 64, time: 550, duration: 400 },    // E4
                    { note: 67, time: 1000, duration: 200 },   // G4
                    { note: 69, time: 1250, duration: 200 },   // A4
                    { note: 67, time: 1500, duration: 400 },   // G4
                    // Second phrase
                    { note: 69, time: 2070, duration: 300 },   // A4
                    { note: 67, time: 2420, duration: 150 },   // G4
                    { note: 64, time: 2620, duration: 400 },   // E4
                    { note: 62, time: 3070, duration: 200 },   // D4
                    { note: 64, time: 3320, duration: 200 },   // E4
                    { note: 67, time: 3570, duration: 500 },   // G4
                ],
                loopLength: 4140
            },
            sweetdreams: {
                preset: 'bass',
                bpm: 126,
                loop: true,
                pattern: [
                    // Sweet Dreams - Eurythmics arpeggio
                    { note: 48, time: 0, duration: 100 },      // C3
                    { note: 60, time: 119, duration: 100 },    // C4
                    { note: 55, time: 238, duration: 100 },    // G3
                    { note: 60, time: 357, duration: 100 },    // C4
                    { note: 48, time: 476, duration: 100 },    // C3
                    { note: 60, time: 595, duration: 100 },    // C4
                    { note: 55, time: 714, duration: 100 },    // G3
                    { note: 60, time: 833, duration: 100 },    // C4
                    // Variation
                    { note: 46, time: 952, duration: 100 },    // Bb2
                    { note: 58, time: 1071, duration: 100 },   // Bb3
                    { note: 53, time: 1190, duration: 100 },   // F3
                    { note: 58, time: 1309, duration: 100 },   // Bb3
                    { note: 46, time: 1428, duration: 100 },   // Bb2
                    { note: 58, time: 1547, duration: 100 },   // Bb3
                    { note: 53, time: 1666, duration: 100 },   // F3
                    { note: 58, time: 1785, duration: 100 },   // Bb3
                ],
                loopLength: 1904
            }
        };

        function playDemo(name) {
            stopDemo();

            const demo = demos[name];
            if (!demo) return;

            initAudio();
            currentDemo = name;

            // Load preset
            loadPreset(demo.preset);

            // Update UI
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('playing');
                if (btn.dataset.demo === name) {
                    btn.classList.add('playing');
                }
            });

            // Schedule notes
            function schedulePattern() {
                const startTime = audioCtx.currentTime * 1000;

                demo.pattern.forEach(event => {
                    const noteOnTimeout = setTimeout(() => {
                        if (currentDemo !== name) return;
                        noteOn(event.note);
                        // Visual feedback on keyboard
                        const keyEl = document.querySelector(`[data-midi="${event.note}"]`);
                        if (keyEl) keyEl.classList.add('pressed');
                    }, event.time);

                    const noteOffTimeout = setTimeout(() => {
                        if (currentDemo !== name) return;
                        noteOff(event.note);
                        const keyEl = document.querySelector(`[data-midi="${event.note}"]`);
                        if (keyEl) keyEl.classList.remove('pressed');
                    }, event.time + event.duration);

                    demoTimeouts.push(noteOnTimeout, noteOffTimeout);
                });

                if (demo.loop) {
                    demoInterval = setTimeout(() => {
                        if (currentDemo === name) {
                            schedulePattern();
                        }
                    }, demo.loopLength);
                }
            }

            schedulePattern();
        }

        function stopDemo() {
            // Clear all timeouts
            demoTimeouts.forEach(t => clearTimeout(t));
            demoTimeouts = [];

            if (demoInterval) {
                clearTimeout(demoInterval);
                demoInterval = null;
            }

            // Release all notes
            voices.forEach((voice, note) => {
                releaseVoice(voice);
                const keyEl = document.querySelector(`[data-midi="${note}"]`);
                if (keyEl) keyEl.classList.remove('pressed');
            });
            voices.clear();

            // Update UI
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('playing');
            });

            // Turn off LEDs
            document.getElementById('vco1-led').classList.remove('on');
            document.getElementById('vco2-led').classList.remove('on');
            document.getElementById('vco3-led').classList.remove('on');
            document.getElementById('master-led').classList.remove('on');

            currentDemo = null;
        }

        function initDemoButtons() {
            document.querySelectorAll('.demo-btn[data-demo]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const demoName = btn.dataset.demo;
                    if (currentDemo === demoName) {
                        stopDemo();
                    } else {
                        playDemo(demoName);
                    }
                });
            });

            document.getElementById('stop-demo').addEventListener('click', stopDemo);
        }

        // Audio Recording
        let mediaRecorder = null;
        let recordedChunks = [];
        let mediaStreamDest = null;

        function initRecording() {
            const recBtn = document.getElementById('rec-btn');

            recBtn.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
        }

        function startRecording() {
            initAudio();

            if (!mediaStreamDest) {
                mediaStreamDest = audioCtx.createMediaStreamDestination();
                analyser.connect(mediaStreamDest);
            }

            recordedChunks = [];

            const options = { mimeType: 'audio/webm' };
            try {
                mediaRecorder = new MediaRecorder(mediaStreamDest.stream, options);
            } catch (e) {
                // Fallback if webm not supported
                mediaRecorder = new MediaRecorder(mediaStreamDest.stream);
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `moog-recording-${Date.now()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            mediaRecorder.start();

            const recBtn = document.getElementById('rec-btn');
            recBtn.classList.add('recording');
            recBtn.textContent = '‚èπÔ∏è STOP';
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();

                const recBtn = document.getElementById('rec-btn');
                recBtn.classList.remove('recording');
                recBtn.textContent = 'üî¥ REC';
            }
        }

        // User Presets (localStorage)
        const USER_PRESETS_KEY = 'moog-modular-user-presets';

        function getUserPresets() {
            const stored = localStorage.getItem(USER_PRESETS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveUserPresets(presets) {
            localStorage.setItem(USER_PRESETS_KEY, JSON.stringify(presets));
        }

        function getCurrentStateAsPreset() {
            return {
                vco1: { wave: state.vco1.wave, octave: state.vco1.octave, detune: state.vco1.detune },
                vco2: { wave: state.vco2.wave, octave: state.vco2.octave, detune: state.vco2.detune },
                vco3: { wave: state.vco3.wave, octave: state.vco3.octave, detune: state.vco3.detune },
                mixer: {
                    vco1: Math.round(state.mixer.vco1 * 100),
                    vco2: Math.round(state.mixer.vco2 * 100),
                    vco3: Math.round(state.mixer.vco3 * 100),
                    noise: Math.round(state.mixer.noise * 100)
                },
                filter: {
                    cutoff: state.filter.cutoff,
                    resonance: state.filter.resonance,
                    envAmount: state.filter.envAmount,
                    kbdTrack: state.filter.kbdTrack
                },
                filterEnv: { ...state.filterEnv },
                ampEnv: { ...state.ampEnv },
                effects: { ...state.effects },
                glide: state.master.glide,
                lfo1: { ...state.lfo1 },
                lfo2: { ...state.lfo2 }
            };
        }

        function updatePresetDropdown() {
            const select = document.getElementById('user-presets');
            const userPresets = getUserPresets();

            // Clear existing options except the first one
            select.innerHTML = '<option value="">-- Select --</option>';

            // Add user presets
            Object.keys(userPresets).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function initPresetManager() {
            updatePresetDropdown();

            // Load button
            document.getElementById('load-preset-btn').addEventListener('click', () => {
                const select = document.getElementById('user-presets');
                const presetName = select.value;

                if (!presetName) {
                    alert('Select a preset first!');
                    return;
                }

                const userPresets = getUserPresets();
                if (userPresets[presetName]) {
                    loadPresetData(userPresets[presetName]);
                }
            });

            // Save button
            document.getElementById('save-preset-btn').addEventListener('click', () => {
                const name = prompt('Enter preset name:');
                if (!name || !name.trim()) return;

                const cleanName = name.trim();
                const userPresets = getUserPresets();

                if (userPresets[cleanName]) {
                    if (!confirm(`Overwrite "${cleanName}"?`)) return;
                }

                userPresets[cleanName] = getCurrentStateAsPreset();
                saveUserPresets(userPresets);
                updatePresetDropdown();

                // Select the newly saved preset
                document.getElementById('user-presets').value = cleanName;
                alert(`Preset "${cleanName}" saved!`);
            });

            // Delete button
            document.getElementById('delete-preset-btn').addEventListener('click', () => {
                const select = document.getElementById('user-presets');
                const presetName = select.value;

                if (!presetName) {
                    alert('Select a preset first!');
                    return;
                }

                if (!confirm(`Delete "${presetName}"?`)) return;

                const userPresets = getUserPresets();
                delete userPresets[presetName];
                saveUserPresets(userPresets);
                updatePresetDropdown();
            });
        }

        function loadPresetData(preset) {
            // Helper to set knob
            function setKnob(param, value) {
                const knob = document.querySelector(`[data-param="${param}"]`);
                if (knob) {
                    knob.dataset.value = value;
                    const min = parseFloat(knob.dataset.min);
                    const max = parseFloat(knob.dataset.max);
                    const isLog = knob.dataset.log === 'true';
                    updateKnobRotation(knob, value, min, max, isLog);
                    updateKnobValue(param, value);
                    applyParameter(param, value);
                }
            }

            // VCOs
            for (let i = 1; i <= 3; i++) {
                const vco = preset[`vco${i}`];
                if (vco) {
                    setKnob(`vco${i}-octave`, vco.octave);
                    setKnob(`vco${i}-detune`, vco.detune);

                    // Set wave
                    document.querySelectorAll(`.wave-btn[data-vco="${i}"]`).forEach(b => {
                        b.classList.toggle('active', b.dataset.wave === vco.wave);
                    });
                    state[`vco${i}`].wave = vco.wave;
                }
            }

            // Mixer
            if (preset.mixer) {
                setKnob('mix1', preset.mixer.vco1);
                setKnob('mix2', preset.mixer.vco2);
                setKnob('mix3', preset.mixer.vco3);
                setKnob('noise', preset.mixer.noise);
            }

            // Filter
            if (preset.filter) {
                setKnob('cutoff', preset.filter.cutoff);
                setKnob('resonance', preset.filter.resonance);
                setKnob('filter-env', preset.filter.envAmount);
                setKnob('filter-kbd', preset.filter.kbdTrack);
            }

            // Envelopes
            if (preset.filterEnv) {
                setKnob('f-attack', preset.filterEnv.attack);
                setKnob('f-decay', preset.filterEnv.decay);
                setKnob('f-sustain', preset.filterEnv.sustain);
                setKnob('f-release', preset.filterEnv.release);
            }

            if (preset.ampEnv) {
                setKnob('a-attack', preset.ampEnv.attack);
                setKnob('a-decay', preset.ampEnv.decay);
                setKnob('a-sustain', preset.ampEnv.sustain);
                setKnob('a-release', preset.ampEnv.release);
            }

            // Effects
            if (preset.effects) {
                setKnob('delay-time', preset.effects.delayTime);
                setKnob('delay-feedback', preset.effects.delayFeedback);
                setKnob('delay-mix', preset.effects.delayMix);
                setKnob('reverb-mix', preset.effects.reverbMix);
            }

            // Glide
            if (preset.glide !== undefined) {
                setKnob('glide', preset.glide);
            }

            // LFOs
            if (preset.lfo1) {
                setKnob('lfo1-rate', preset.lfo1.rate);
                setKnob('lfo1-amount', preset.lfo1.amount);
                document.querySelectorAll('.wave-btn[data-lfo="1"]').forEach(b => {
                    b.classList.toggle('active', b.dataset.wave === preset.lfo1.wave);
                });
                state.lfo1.wave = preset.lfo1.wave;
                state.lfo1.dest = preset.lfo1.dest;
                document.getElementById('lfo1-dest').value = preset.lfo1.dest;
                if (lfo1Osc) lfo1Osc.type = preset.lfo1.wave;
            }

            if (preset.lfo2) {
                setKnob('lfo2-rate', preset.lfo2.rate);
                setKnob('lfo2-amount', preset.lfo2.amount);
                document.querySelectorAll('.wave-btn[data-lfo="2"]').forEach(b => {
                    b.classList.toggle('active', b.dataset.wave === preset.lfo2.wave);
                });
                state.lfo2.wave = preset.lfo2.wave;
                state.lfo2.dest = preset.lfo2.dest;
                document.getElementById('lfo2-dest').value = preset.lfo2.dest;
                if (lfo2Osc) lfo2Osc.type = preset.lfo2.wave;
            }

            // Update waveforms on active voices
            updateActiveWaveforms();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createKeyboard();
            initKnobs();
            initWaveSelectors();
            initDemoButtons();
            initRecording();
            initPresetManager();

            // Draw initial envelopes
            drawEnvelope('filter-env-display', state.filterEnv.attack, state.filterEnv.decay, state.filterEnv.sustain, state.filterEnv.release);
            drawEnvelope('amp-env-display', state.ampEnv.attack, state.ampEnv.decay, state.ampEnv.sustain, state.ampEnv.release);
        });
    </script>

    <footer style="text-align:center;padding:20px;color:#888;font-size:0.85em;border-top:1px solid #333;margin-top:20px;">
        Made with ‚ù§Ô∏è by <a href="https://a80.it" target="_blank" style="color:#ffd700;text-decoration:none;">Mircha Emanuel D'Angelo</a>
    </footer>
</body>
</html>
